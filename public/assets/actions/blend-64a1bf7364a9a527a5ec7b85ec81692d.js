/*
 * Pixastic Lib - Blend - v0.1.1
 * Copyright (c) 2008 Jacob Seidelin, jseidelin@nihilogic.dk, http://blog.nihilogic.dk/
 * License: [http://www.pixastic.com/lib/license.txt]
 */
Pixastic.Actions.blend={process:function(e){var t=parseFloat(e.options.amount),n=(e.options.mode||"normal").toLowerCase(),r=e.options.image;t=Math.max(0,Math.min(1,t));if(!r)return!1;if(Pixastic.Client.hasCanvasImageData()){var i=e.options.rect,s=Pixastic.prepareData(e),o=i.width,u=i.height;e.useData=!1;var a=document.createElement("canvas");a.width=e.canvas.width,a.height=e.canvas.height;var f=a.getContext("2d");f.drawImage(r,0,0);var l={canvas:a,options:e.options},c=Pixastic.prepareData(l),h=l.canvasData,p=o*u,d=p*4,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A=!1;switch(n){case"normal":break;case"multiply":while(p--)c[d-=4]=s[d]*c[d]/255,c[v=d+1]=s[v]*c[v]/255,c[m=d+2]=s[m]*c[m]/255;A=!0;break;case"lighten":while(p--)(g=s[d-=4])>c[d]&&(c[d]=g),(y=s[v=d+1])>c[v]&&(c[v]=y),(b=s[m=d+2])>c[m]&&(c[m]=b);A=!0;break;case"darken":while(p--)(g=s[d-=4])<c[d]&&(c[d]=g),(y=s[v=d+1])<c[v]&&(c[v]=y),(b=s[m=d+2])<c[m]&&(c[m]=b);A=!0;break;case"darkercolor":while(p--)(g=s[d-=4])*.3+(y=s[v=d+1])*.59+(b=s[m=d+2])*.11<=c[d]*.3+c[v]*.59+c[m]*.11&&(c[d]=g,c[v]=y,c[m]=b);A=!0;break;case"lightercolor":while(p--)(g=s[d-=4])*.3+(y=s[v=d+1])*.59+(b=s[m=d+2])*.11>c[d]*.3+c[v]*.59+c[m]*.11&&(c[d]=g,c[v]=y,c[m]=b);A=!0;break;case"lineardodge":while(p--)(x=s[d-=4]+c[d])>255?c[d]=255:c[d]=x,(T=s[v=d+1]+c[v])>255?c[v]=255:c[v]=T,(N=s[m=d+2]+c[m])>255?c[m]=255:c[m]=N;A=!0;break;case"linearburn":while(p--)(x=s[d-=4]+c[d])<255?c[d]=0:c[d]=x-255,(T=s[v=d+1]+c[v])<255?c[v]=0:c[v]=T-255,(N=s[m=d+2]+c[m])<255?c[m]=0:c[m]=N-255;A=!0;break;case"difference":while(p--)(x=s[d-=4]-c[d])<0?c[d]=-x:c[d]=x,(T=s[v=d+1]-c[v])<0?c[v]=-T:c[v]=T,(N=s[m=d+2]-c[m])<0?c[m]=-N:c[m]=N;A=!0;break;case"screen":while(p--)c[d-=4]=255-((255-c[d])*(255-s[d])>>8),c[v=d+1]=255-((255-c[v])*(255-s[v])>>8),c[m=d+2]=255-((255-c[m])*(255-s[m])>>8);A=!0;break;case"exclusion":var O=2/255;while(p--)c[d-=4]=(g=s[d])-(g*O-1)*c[d],c[v=d+1]=(y=s[v])-(y*O-1)*c[v],c[m=d+2]=(b=s[m])-(b*O-1)*c[m];A=!0;break;case"overlay":var O=2/255;while(p--)(g=s[d-=4])<128?c[d]=c[d]*g*O:c[d]=255-(255-c[d])*(255-g)*O,(y=s[v=d+1])<128?c[v]=c[v]*y*O:c[v]=255-(255-c[v])*(255-y)*O,(b=s[m=d+2])<128?c[m]=c[m]*b*O:c[m]=255-(255-c[m])*(255-b)*O;A=!0;break;case"softlight":var O=2/255;while(p--)(g=s[d-=4])<128?c[d]=((c[d]>>1)+64)*g*O:c[d]=255-(191-(c[d]>>1))*(255-g)*O,(y=s[v=d+1])<128?c[v]=((c[v]>>1)+64)*y*O:c[v]=255-(191-(c[v]>>1))*(255-y)*O,(b=s[m=d+2])<128?c[m]=((c[m]>>1)+64)*b*O:c[m]=255-(191-(c[m]>>1))*(255-b)*O;A=!0;break;case"hardlight":var O=2/255;while(p--)(w=c[d-=4])<128?c[d]=s[d]*w*O:c[d]=255-(255-s[d])*(255-w)*O,(E=c[v=d+1])<128?c[v]=s[v]*E*O:c[v]=255-(255-s[v])*(255-E)*O,(S=c[m=d+2])<128?c[m]=s[m]*S*O:c[m]=255-(255-s[m])*(255-S)*O;A=!0;break;case"colordodge":while(p--)(x=(s[d-=4]<<8)/(255-(w=c[d])))>255||w==255?c[d]=255:c[d]=x,(T=(s[v=d+1]<<8)/(255-(E=c[v])))>255||E==255?c[v]=255:c[v]=T,(N=(s[m=d+2]<<8)/(255-(S=c[m])))>255||S==255?c[m]=255:c[m]=N;A=!0;break;case"colorburn":while(p--)(x=255-(255-s[d-=4]<<8)/c[d])<0||c[d]==0?c[d]=0:c[d]=x,(T=255-(255-s[v=d+1]<<8)/c[v])<0||c[v]==0?c[v]=0:c[v]=T,(N=255-(255-s[m=d+2]<<8)/c[m])<0||c[m]==0?c[m]=0:c[m]=N;A=!0;break;case"linearlight":while(p--)(x=2*(w=c[d-=4])+s[d]-256)<0||w<128&&x<0?c[d]=0:x>255?c[d]=255:c[d]=x,(T=2*(E=c[v=d+1])+s[v]-256)<0||E<128&&T<0?c[v]=0:T>255?c[v]=255:c[v]=T,(N=2*(S=c[m=d+2])+s[m]-256)<0||S<128&&N<0?c[m]=0:N>255?c[m]=255:c[m]=N;A=!0;break;case"vividlight":while(p--)(w=c[d-=4])<128?w?(x=255-(255-s[d]<<8)/(2*w))<0?c[d]=0:c[d]=x:c[d]=0:(x=C=2*w-256)<255?(x=(s[d]<<8)/(255-C))>255?c[d]=255:c[d]=x:x<0?c[d]=0:c[d]=x,(E=c[v=d+1])<128?E?(T=255-(255-s[v]<<8)/(2*E))<0?c[v]=0:c[v]=T:c[v]=0:(T=k=2*E-256)<255?(T=(s[v]<<8)/(255-k))>255?c[v]=255:c[v]=T:T<0?c[v]=0:c[v]=T,(S=c[m=d+2])<128?S?(N=255-(255-s[m]<<8)/(2*S))<0?c[m]=0:c[m]=N:c[m]=0:(N=L=2*S-256)<255?(N=(s[m]<<8)/(255-L))>255?c[m]=255:c[m]=N:N<0?c[m]=0:c[m]=N;A=!0;break;case"pinlight":while(p--)(w=c[d-=4])<128?(g=s[d])<(C=2*w)?c[d]=g:c[d]=C:(g=s[d])>(C=2*w-256)?c[d]=g:c[d]=C,(E=c[v=d+1])<128?(y=s[v])<(k=2*E)?c[v]=y:c[v]=k:(y=s[v])>(k=2*E-256)?c[v]=y:c[v]=k,(w=c[m=d+2])<128?(g=s[m])<(C=2*w)?c[m]=g:c[m]=C:(g=s[m])>(C=2*w-256)?c[m]=g:c[m]=C;A=!0;break;case"hardmix":while(p--)(w=c[d-=4])<128?255-(255-s[d]<<8)/(2*w)<128||w==0?c[d]=0:c[d]=255:(C=2*w-256)<255&&(s[d]<<8)/(255-C)<128?c[d]=0:c[d]=255,(E=c[v=d+1])<128?255-(255-s[v]<<8)/(2*E)<128||E==0?c[v]=0:c[v]=255:(k=2*E-256)<255&&(s[v]<<8)/(255-k)<128?c[v]=0:c[v]=255,(S=c[m=d+2])<128?255-(255-s[m]<<8)/(2*S)<128||S==0?c[m]=0:c[m]=255:(L=2*S-256)<255&&(s[m]<<8)/(255-L)<128?c[m]=0:c[m]=255;A=!0}A&&f.putImageData(h,0,0);if(t!=1&&!Pixastic.Client.hasGlobalAlpha()){var p=o*u,M=t,_=1-t;while(p--){var d=p*4,D=s[d]*_+c[d]*M>>0,P=s[d+1]*_+c[d+1]*M>>0,H=s[d+2]*_+c[d+2]*M>>0;s[d]=D,s[d+1]=P,s[d+2]=H}e.useData=!0}else{var B=e.canvas.getContext("2d");B.save(),B.globalAlpha=t,B.drawImage(a,0,0,i.width,i.height,i.left,i.top,i.width,i.height),B.globalAlpha=1,B.restore()}return!0}},checkSupport:function(){return Pixastic.Client.hasCanvasImageData()}};