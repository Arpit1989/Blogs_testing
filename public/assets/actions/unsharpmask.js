/*
 * Pixastic Lib - USM - v0.1.0
 * Copyright (c) 2008 Jacob Seidelin, jseidelin@nihilogic.dk, http://blog.nihilogic.dk/
 * License: [http://www.pixastic.com/lib/license.txt]
 */
Pixastic.Actions.unsharpmask={process:function(e){var t=parseFloat(e.options.amount)||0,n=parseFloat(e.options.radius)||0,r=parseFloat(e.options.threshold)||0;t=Math.min(500,Math.max(0,t))/2,n=Math.min(5,Math.max(0,n))/10,r=Math.min(255,Math.max(0,r)),r--;var i=-r;t*=.016,t++;if(Pixastic.Client.hasCanvasImageData()){var s=e.options.rect,o=document.createElement("canvas");o.width=e.width,o.height=e.height;var u=o.getContext("2d");u.drawImage(e.canvas,0,0);var a=2,f=Math.round(e.width/a),l=Math.round(e.height/a),c=document.createElement("canvas");c.width=f,c.height=l;var h=Math.round(n*20),p=c.getContext("2d");for(var d=0;d<h;d++){var v=Math.max(1,Math.round(f-d)),m=Math.max(1,Math.round(l-d));p.clearRect(0,0,f,l),p.drawImage(o,0,0,e.width,e.height,0,0,v,m),u.clearRect(0,0,e.width,e.height),u.drawImage(c,0,0,v,m,0,0,e.width,e.height)}var g=Pixastic.prepareData(e),y=Pixastic.prepareData({canvas:o,options:e.options}),b=s.width,w=s.height,E=b*4,S=w;do{var x=(S-1)*E,T=b;do{var N=x+(T*4-4),C=g[N]-y[N];if(C>r||C<i){var k=y[N];k=t*C+k,g[N]=k>255?255:k<0?0:k}var L=g[N+1]-y[N+1];if(L>r||L<i){var A=y[N+1];A=t*L+A,g[N+1]=A>255?255:A<0?0:A}var O=g[N+2]-y[N+2];if(O>r||O<i){var M=y[N+2];M=t*O+M,g[N+2]=M>255?255:M<0?0:M}}while(--T)}while(--S);return!0}},checkSupport:function(){return Pixastic.Client.hasCanvasImageData()}};